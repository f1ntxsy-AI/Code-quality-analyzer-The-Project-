name: Code Quality CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Job 1: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run pytest
      run: |
        pytest tests/ -v --tb=short

    - name: Test CLI
      run: |
        python src/main.py --file examples/good_code.py
        python src/main.py --file examples/bad_code.py


  # Job 2: –ê–Ω–∞–ª–∏–∑ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ –∫–æ–¥–∞
  analyze-student-code:
    name: Analyze Student Submissions
    runs-on: ubuntu-latest
    needs: test  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create reports directory
      run: mkdir -p reports

    - name: Analyze student submissions
      run: |
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–∫–∏ student_submissions
        if [ -d "student_submissions" ]; then
          echo "üìÇ Found student submissions folder"

          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Ñ–∞–π–ª
          for file in student_submissions/*.py; do
            if [ -f "$file" ]; then
              echo "üîç Analyzing: $file"
              python src/main.py --file "$file" --format all
            fi
          done

          echo "‚úÖ All student submissions analyzed"
        else
          echo "‚ö†Ô∏è  No student_submissions folder found"
          echo "Creating example structure..."
          mkdir -p student_submissions
          cp examples/student_submission.py student_submissions/
          python src/main.py --file student_submissions/student_submission.py --format all
        fi

    - name: Generate summary report
      run: |
        echo "# üìä Student Code Quality Report" > reports/summary.md
        echo "" >> reports/summary.md
        echo "Generated: $(date)" >> reports/summary.md
        echo "" >> reports/summary.md
        echo "## Analyzed Files" >> reports/summary.md
        echo "" >> reports/summary.md

        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª—ã
        if [ -d "student_submissions" ]; then
          file_count=$(ls -1 student_submissions/*.py 2>/dev/null | wc -l)
          echo "Total submissions: $file_count" >> reports/summary.md
          echo "" >> reports/summary.md

          # –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
          for file in student_submissions/*.py; do
            if [ -f "$file" ]; then
              echo "- $(basename $file)" >> reports/summary.md
            fi
          done
        fi

        echo "" >> reports/summary.md
        echo "## Reports Generated" >> reports/summary.md
        echo "" >> reports/summary.md
        ls -1 reports/ >> reports/summary.md

    - name: Upload reports as artifacts
      uses: actions/upload-artifact@v3
      with:
        name: code-quality-reports
        path: reports/
        retention-days: 30

    - name: Display summary
      run: |
        echo "=" 
        echo "üìä ANALYSIS COMPLETE"
        echo "="
        cat reports/summary.md


  # Job 3: Quality Gate (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  quality-gate:
    name: Quality Gate Check
    runs-on: ubuntu-latest
    needs: analyze-student-code
    if: always()

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Check minimum quality threshold
      run: |
        echo "üéØ Checking quality thresholds..."

        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º examples –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Ä–æ–≥–æ–≤
        python src/main.py --file examples/good_code.py > /tmp/good_result.txt

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ö–æ—Ä–æ—à–∏–π –∫–æ–¥ –ø–æ–ª—É—á–∞–µ—Ç A
        if grep -q "OVERALL SCORE: 100" /tmp/good_result.txt; then
          echo "‚úÖ Quality gate: PASSED"
          echo "Good code scores 100/100 as expected"
        else
          echo "‚ö†Ô∏è  Quality gate: WARNING"
          echo "Good code did not score 100/100"
        fi
